#!/usr/bin/env bash

set -e

MIRROR="https://ftp.jaist.ac.jp/pub/Linux/Gentoo"
STAGE3="$MIRROR/releases/amd64/autobuilds/current-stage3-amd64-llvm-openrc"
LATEST="$STAGE3/latest-stage3-amd64-llvm-openrc.txt"
REPO="gentoo"

function pull() {
  local file=`curl "$LATEST" | grep -o "stage3.* " | xargs`
  docker image rm `docker image ls -q -f "reference=$REPO"` 2>/dev/null || true
  exec docker import "$STAGE3/$file" "$REPO" "$@"
}

function run() {
  function v() {
    echo "-v $1:$1"
  }

  local cmd='
    set -e

    cat <<- EOS >> /etc/portage/make.conf
			ACCEPT_KEYWORDS="~amd64 ~arm64"
			ACCEPT_LICENSE="* -@EULA"
		EOS

    exec bash
  '

  exec docker run --rm -it --privileged \
    `v /etc/portage/repos.conf` \
    `v /tmp` `v /var/cache` `v /var/db/repos` `v /var/tmp` \
    "$REPO" bash -c "$cmd"
}

function usage() {
  echo usage: wip
}

case "$1" in
  "pull") pull "${@:2}";;
  "run") run "${@:2}";;
  *) usage; exit 1;;
esac
